<head>
  <title>English Words</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,500;1,200&display=swap">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <style media="screen">
    html {
      font-size: 13px;
    }
    body {
      padding: 0.5em;
      background: #111;
      font-family: 'Montserrat', sans-serif;
      color: white;
    }
    h1 {
      text-transform: capitalize;
    }
    audio {
      width: 100%;
      margin:10px;
    }

    ul {
      margin:0 0 2em 0;
      padding-left:0;
      list-style-type: none;
    }

    ul ul {
      margin:0 0 1em 0;
      padding-left:1em;
    }

  </style>
</head>
<body>
  <div id="app" class="container p-3">
    <div class="row">
      <div class="col-12">
        <div class="row">
          <div class="col-8"><h1>{{ word }}</h1></div>
          <div class="col-4 text-end">
            <a v-on:click="reloadWord" class="btn btn-primary"><i class="fa fa-file-o"></i>  Next</a>
          </div>
        </div>
      </div>
      <div class="col-12 text-center">
        <audio id="audio" controls v-if="word_audio && word_audio.length">
          <source id="audio-source" v-bind:src="word_audio" type="audio/ogg">
          Your browser does not support the audio element.
        </audio>
        <em>{{ word_pr }}</em>
      </div>
    </div>

    <ul v-if="definitions.length">
      <li v-for="item in definitions">
        <em>{{ item.type }}</em>
        <ul>
          <li v-for="definition in item.definitions">{{ definition }} </li>
        </ul>
      </li>
    </ul>

  </div>
  <script type="text/javascript">
    const urlParams = new URLSearchParams(window.location.search);
    const apiKey = urlParams.get('apiKey');

    const app = new Vue({
      el: '#app',
      data: {
        words: [],
        word: '',
        definitions: [],
        word_pr : '',
        word_audio: null,
        dictionary: []
      },
      created () {
        // Load words:
        var url = 'words.txt';
        axios.get(url)
          .then(response => {

            var array = response.data.split("\n");

            var filtered = array.filter(function (el) {
              return el != null && el.length > 0;
            });

            this.words = filtered;
            this.reloadWord();
          });
      },
      methods: {
        reloadWord: function (event) {
          const idx = Math.floor(Math.random() * this.words.length);
          this.word = this.words[idx];
          var url = 'https://www.dictionaryapi.com/api/v3/references/sd3/json/' + this.word + '?key=' + apiKey;
          axios.get(url)
            .then(response => {
              // @TODO response code!
              var api = response.data;

              if (typeof(api) !== 'undefined' && typeof(api[0].fl) !== 'undefined') {

                var items = {};
                response.data.forEach(
                  element => {
                    // init type
                    if (typeof(element.fl) !== 'undefined') {
                      if (typeof(items[element.fl]) == 'undefined') {
                        items[element.fl] = {
                          'type': element.fl,
                          'definitions': element.shortdef
                        }
                      }
                      else {
                        items[element.fl].definitions = items[element.fl].definitions.concat(element.shortdef);
                      }
                    }
                  }
                );

                var itemsa = [];
                Object.values(items).forEach(val => {
                  itemsa.push(val);
                });

                this.definitions = itemsa;

                this.word_fl = api[0].fl;
                this.word_pr = api[0].hwi.prs[0].mw;

                var audio_url = '';

                if (typeof(api[0].hwi) !== 'undefined' && typeof(api[0].hwi.prs) !== 'undefined' && typeof(api[0].hwi.prs[0]) !== 'undefined' && typeof(api[0].hwi.prs[0].sound) !== 'undefined') {
                  var audio = api[0].hwi.prs[0].sound.audio;
                  if (audio.length) {
                    var subdirectory = '';
                    // if audio begins with "bix", the subdirectory should be "bix",
                    // if audio begins with "gg", the subdirectory should be "gg",
                    // if audio begins with a number or punctuation (eg, "_"), the subdirectory should be "number",
                    // otherwise, the subdirectory is equal to the first letter of audio.
                    if (audio.startsWith('bix')) {
                      subdirectory = 'bix';
                    }
                    else if (audio.startsWith('gg')) {
                      subdirectory = 'gg';
                    }
                    else if (audio.startsWith('_')) {
                      subdirectory = 'number';
                    }
                    else {
                      subdirectory = audio[0];
                    }

                    var language_code = 'en';
                    var country_code = 'us';
                    var format = 'ogg';
                    audio_url = 'https://media.merriam-webster.com/audio/prons/' + language_code + '/' + country_code + '/' + format + '/' + subdirectory + '/' + audio + '.' + format;
                  }

                }

                this.word_audio = audio_url;
                if (audio_url.length > 0) {
                  var audioplayer = document.getElementById('audio');
                  // Preload the audio without playing
                  audioplayer.load();
                  // audio.play();
                }

              }
              else {
                // Reset ALL:
                this.word_fl = '';
                this.word_pr = '';
                this.word_audio = '';
                this.definitions = [];
              }

            });
        }
      }
    });
  </script>
</body>
